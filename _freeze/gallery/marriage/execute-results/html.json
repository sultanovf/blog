{
  "hash": "1edeae4929bd221df3b64136a1d97711",
  "result": {
    "markdown": "---\ntitle: \"marriage{{< fa heart >}}  & {{< fa heart-crack >}}divorce\"\ndescription: \"plotting (animated) the marriages and divorces over the years in Uzbekistan using `ggplot2` and `gganimate`\"\nauthor: \"Fazliddin Sultonov\"\ndate: \"2025-03-02\"\ndate-format: \"MMM D, YYYY\"\n\nfilters:\n  - lightbox\nlightbox: \n  match: auto\n  effect: none\n  desc-position: top\n\npage-layout: full\nreference-location: margin\ncategories: [barplot, R, ggplot2, gganimate, ggpol]\n# Code execute options\nexecute: \n  echo: true    # Input anzeigen\n  eval: true    # Code ausführen\n  freeze: true  # never re-render during project render\n# Output\nformat: \n  html:\n    theme: cosmo\n  # codeb block\n    code-fold: true\n    code-line-numbers: true\n    code-block-border-left: true\n  # engine\n    engine: knitr\n    css: /customs/style.css\n# engine: knitr\n#jupyter: python3\n\n# Chunk Options\nknitr:\n  opts_chunk:\n    comment: \"#>\" \n\n  opts_knit: \n    warning: false\n    error: false\n    \n---\n\n\n\n![](gallery_img/marriage.png)\n\n::: {.cell}\n\n:::\n\n::: {.cell}\n\n:::\n\n\n\n:::: {.column-screen}\n::: {.code-r}\n# `<svg preserveAspectRatio=\"none\" aria-hidden=\"true\" role=\"img\" viewBox=\"0 0 581 512\" style=\"height:2.0em;width:2.0em;vertical-align:-0.125em;margin-left:auto;margin-right:auto;font-size:inherit;fill:steelblue;overflow:visible;position:relative;\"><path d=\"M581 226.6C581 119.1 450.9 32 290.5 32S0 119.1 0 226.6C0 322.4 103.3 402 239.4 418.1V480h99.1v-61.5c24.3-2.7 47.6-7.4 69.4-13.9L448 480h112l-67.4-113.7c54.5-35.4 88.4-84.9 88.4-139.7zm-466.8 14.5c0-73.5 98.9-133 220.8-133s211.9 40.7 211.9 133c0 50.1-26.5 85-70.3 106.4-2.4-1.6-4.7-2.9-6.4-3.7-10.2-5.2-27.8-10.5-27.8-10.5s86.6-6.4 86.6-92.7-90.6-87.9-90.6-87.9h-199V361c-74.1-21.5-125.2-67.1-125.2-119.9zm225.1 38.3v-55.6c57.8 0 87.8-6.8 87.8 27.3 0 36.5-38.2 28.3-87.8 28.3zm-.9 72.5H365c10.8 0 18.9 11.7 24 19.2-16.1 1.9-33 2.8-50.6 2.9v-22.1z\"/></svg>`{=html}{.center-slide}\n\n:::\n::::\n\n\nDatasource: [Statistics Agency under the President of the Republic of Uzbekistan](https://stat.uz/en/) |\nDatastorage: [{{< fa brands square-github >}}GitHub](https://github.com/sultanovf/my_datasets/blob/main/nikohuz_2010_2023.csv)\n\n\n## data\n\n\n::: {.cell .column-screen-inset}\n\n```{.r .cell-code}\ndata <- read.csv2(\"https://raw.githubusercontent.com/sultanovf/my_datasets/main/nikohuz_2010_2023.csv\")\nyears <- paste(2010:2023) #, sep=\",\", collapse= \",\"\nyears <- unlist(strsplit(years, \",\"))\nnew_cnames <- c(\"region\", \"status\", \"area\",  years)\ncolnames(data) <- new_cnames\n\n\nrmarkdown::paged_table(sample_n(data, 10)) # show sample 10 rows\n# oder {r, df_print = \"paged\"}\n# sample_n(data_raw, 10\n```\n\n::: {.cell-output-display}\n`````{=html}\n<div data-pagedtable=\"false\">\n  <script data-pagedtable-source type=\"application/json\">\n{\"columns\":[{\"label\":[\"region\"],\"name\":[1],\"type\":[\"chr\"],\"align\":[\"left\"]},{\"label\":[\"status\"],\"name\":[2],\"type\":[\"chr\"],\"align\":[\"left\"]},{\"label\":[\"area\"],\"name\":[3],\"type\":[\"chr\"],\"align\":[\"left\"]},{\"label\":[\"2010\"],\"name\":[4],\"type\":[\"int\"],\"align\":[\"right\"]},{\"label\":[\"2011\"],\"name\":[5],\"type\":[\"int\"],\"align\":[\"right\"]},{\"label\":[\"2012\"],\"name\":[6],\"type\":[\"int\"],\"align\":[\"right\"]},{\"label\":[\"2013\"],\"name\":[7],\"type\":[\"int\"],\"align\":[\"right\"]},{\"label\":[\"2014\"],\"name\":[8],\"type\":[\"int\"],\"align\":[\"right\"]},{\"label\":[\"2015\"],\"name\":[9],\"type\":[\"int\"],\"align\":[\"right\"]},{\"label\":[\"2016\"],\"name\":[10],\"type\":[\"int\"],\"align\":[\"right\"]},{\"label\":[\"2017\"],\"name\":[11],\"type\":[\"int\"],\"align\":[\"right\"]},{\"label\":[\"2018\"],\"name\":[12],\"type\":[\"int\"],\"align\":[\"right\"]},{\"label\":[\"2019\"],\"name\":[13],\"type\":[\"int\"],\"align\":[\"right\"]},{\"label\":[\"2020\"],\"name\":[14],\"type\":[\"int\"],\"align\":[\"right\"]},{\"label\":[\"2021\"],\"name\":[15],\"type\":[\"int\"],\"align\":[\"right\"]},{\"label\":[\"2022\"],\"name\":[16],\"type\":[\"int\"],\"align\":[\"right\"]},{\"label\":[\"2023\"],\"name\":[17],\"type\":[\"int\"],\"align\":[\"right\"]}],\"data\":[{\"1\":\"Syrdarya region\",\"2\":\"divorce\",\"3\":\"village\",\"4\":\"265\",\"5\":\"211\",\"6\":\"242\",\"7\":\"280\",\"8\":\"267\",\"9\":\"318\",\"10\":\"385\",\"11\":\"498\",\"12\":\"461\",\"13\":\"420\",\"14\":\"452\",\"15\":\"613\",\"16\":\"581\",\"17\":\"544\"},{\"1\":\"Andijan region\",\"2\":\"marriage\",\"3\":\"city\",\"4\":\"13108\",\"5\":\"11893\",\"6\":\"13923\",\"7\":\"14568\",\"8\":\"13473\",\"9\":\"12392\",\"10\":\"12617\",\"11\":\"13274\",\"12\":\"14656\",\"13\":\"15073\",\"14\":\"14796\",\"15\":\"14526\",\"16\":\"13432\",\"17\":\"12717\"},{\"1\":\"Tashkent region\",\"2\":\"divorce\",\"3\":\"city\",\"4\":\"1227\",\"5\":\"1466\",\"6\":\"1255\",\"7\":\"1735\",\"8\":\"1995\",\"9\":\"2195\",\"10\":\"1956\",\"11\":\"2047\",\"12\":\"2084\",\"13\":\"2076\",\"14\":\"1536\",\"15\":\"2074\",\"16\":\"2268\",\"17\":\"2244\"},{\"1\":\"Fergana region\",\"2\":\"marriage\",\"3\":\"village\",\"4\":\"15240\",\"5\":\"14226\",\"6\":\"14850\",\"7\":\"15322\",\"8\":\"15215\",\"9\":\"14705\",\"10\":\"14967\",\"11\":\"17096\",\"12\":\"17213\",\"13\":\"17282\",\"14\":\"16067\",\"15\":\"15919\",\"16\":\"12815\",\"17\":\"13493\"},{\"1\":\"Fergana region\",\"2\":\"marriage\",\"3\":\"city\",\"4\":\"18121\",\"5\":\"17247\",\"6\":\"17251\",\"7\":\"18047\",\"8\":\"17344\",\"9\":\"16155\",\"10\":\"15701\",\"11\":\"16827\",\"12\":\"18235\",\"13\":\"17677\",\"14\":\"18000\",\"15\":\"16885\",\"16\":\"19237\",\"17\":\"17628\"},{\"1\":\"Namangan region\",\"2\":\"divorce\",\"3\":\"village\",\"4\":\"511\",\"5\":\"648\",\"6\":\"556\",\"7\":\"475\",\"8\":\"523\",\"9\":\"680\",\"10\":\"721\",\"11\":\"796\",\"12\":\"808\",\"13\":\"825\",\"14\":\"708\",\"15\":\"912\",\"16\":\"1277\",\"17\":\"1417\"},{\"1\":\"Republic of Karakalpakstan\",\"2\":\"marriage\",\"3\":\"village\",\"4\":\"10040\",\"5\":\"9938\",\"6\":\"9255\",\"7\":\"9035\",\"8\":\"8405\",\"9\":\"7555\",\"10\":\"7119\",\"11\":\"7875\",\"12\":\"7807\",\"13\":\"7511\",\"14\":\"6234\",\"15\":\"8211\",\"16\":\"7951\",\"17\":\"7405\"},{\"1\":\"Khorezm region\",\"2\":\"marriage\",\"3\":\"city\",\"4\":\"3981\",\"5\":\"4646\",\"6\":\"5041\",\"7\":\"4705\",\"8\":\"4611\",\"9\":\"4385\",\"10\":\"4296\",\"11\":\"4912\",\"12\":\"4950\",\"13\":\"4995\",\"14\":\"4542\",\"15\":\"5135\",\"16\":\"5580\",\"17\":\"5158\"},{\"1\":\"Syrdarya region\",\"2\":\"marriage\",\"3\":\"city\",\"4\":\"4289\",\"5\":\"4458\",\"6\":\"4532\",\"7\":\"4964\",\"8\":\"3231\",\"9\":\"3293\",\"10\":\"2706\",\"11\":\"2909\",\"12\":\"3495\",\"13\":\"4358\",\"14\":\"4387\",\"15\":\"3863\",\"16\":\"5574\",\"17\":\"3450\"},{\"1\":\"Navoi region\",\"2\":\"marriage\",\"3\":\"village\",\"4\":\"5203\",\"5\":\"5522\",\"6\":\"5881\",\"7\":\"4671\",\"8\":\"5016\",\"9\":\"4844\",\"10\":\"4631\",\"11\":\"5020\",\"12\":\"5305\",\"13\":\"4843\",\"14\":\"5269\",\"15\":\"4774\",\"16\":\"3951\",\"17\":\"3788\"}],\"options\":{\"columns\":{\"min\":{},\"max\":[10]},\"rows\":{\"min\":[10],\"max\":[10]},\"pages\":{}}}\n  </script>\n</div>\n`````\n:::\n:::\n\n\n\n\n## pivot data\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndf<- data\n# pivot data\ndf_pv<-\n  df |> \n  pivot_longer(\n    cols = !c(region, status, area),\n    names_to = \"year\",\n    values_to = \"value\"\n  )  \n\ndf_pv |> \n  sample_n(7)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n#> # A tibble: 7 × 5\n#>   region             status   area    year  value\n#>   <chr>              <chr>    <chr>   <chr> <int>\n#> 1 Samarkand region   divorce  village 2021   2226\n#> 2 Bukhara region     marriage city    2020   5422\n#> 3 Kashkadarya region divorce  city    2023   1790\n#> 4 Navoi region       divorce  city    2015    711\n#> 5 Samarkand region   marriage city    2010  11116\n#> 6 Navoi region       marriage city    2012   3867\n#> 7 Jizzakh region     marriage village 2010   6870\n```\n:::\n:::\n\n\n\n## prepare data for plot\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndf_pl <-\n  df|> \n  pivot_longer(\n    cols = !c(region, status, area),\n    names_to = \"year\",\n    values_to = \"value\"\n  ) |> \n  group_by(year, status) |> \n  summarise(value = sum(value)) |> \n  mutate(\n    #frame = row_number(),\n    year = as.integer(year),\n    value = case_when(\n      status == \"divorce\" ~ round(value/1000, 1)*-1,\n      TRUE ~ round(value/1000, 1))\n    ) |>\n  ungroup()\n\nhead(df_pl)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n#> # A tibble: 6 × 3\n#>    year status   value\n#>   <int> <chr>    <dbl>\n#> 1  2010 divorce  -14.3\n#> 2  2010 marriage 273. \n#> 3  2011 divorce  -15.1\n#> 4  2011 marriage 269. \n#> 5  2012 divorce  -14.3\n#> 6  2012 marriage 280.\n```\n:::\n:::\n\n\n\n\n\n## pyramid #1\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Title/subtitle/datasource\ndata_source <- \"©Statistics Agency under the President of the Republic of Uzbekistan\"\np_title <- \"<br>Браки и разводы в Узбекистане в 2010-2023 гг.\"\np_subtitle <- \"\"\n\n# caption\nsocial_caption <- glue::glue(\n  \"<span style = 'color:skyblue3;'><i><strong><br>DataSource: {data_source} <br/></strong></i></span>  Plot by:\n  <span style='color: #C4302B; font-family:\\\"Font Awesome 6 Brands\\\";'>{yt_icon};</span>\n  <span style='color: #C4302B'>{yt_username}</span> |\n  <span style='color: #e1306c; font-family:\\\"Font Awesome 6 Brands\\\";'>{ins_icon};</span>\n  <span style='color: #e1306c'>{ins_username}</span> |\n  <span style='color: #24A1DE; font-family:\\\"Font Awesome 6 Brands\\\";'>{tg_icon};</span>\n  <span style='color: #24A1DE'>{tg_username}<br></span>\"\n)\n\n# caption\nsocial_caption_anim <- glue::glue(\n  \"  <span style='color: #C4302B; font-family:\\\"Font Awesome 6 Brands\\\";'>{yt_icon};</span>\n  <span style='color: #C4302B'>{yt_username}</span> |\n  <span style='color: #e1306c; font-family:\\\"Font Awesome 6 Brands\\\";'>{ins_icon};</span>\n  <span style='color: #e1306c'>{ins_username}</span> |\n  <span style='color: #24A1DE; font-family:\\\"Font Awesome 6 Brands\\\";'>{tg_icon};</span>\n  <span style='color: #24A1DE'>{tg_username}<br></span>\"\n)\n\nf_path <- \"C:/Users/sultanov/Documents/fontawesome/otfs/\"\nsysfonts::font_add(\n  family = 'Font Awesome 6 Brands', \n  regular = paste0(f_path, \"Font Awesome 6 Brands-Regular-400.otf\"))\n\nshowtext::showtext_auto()\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# create plot\npl <- \n  ggplot(df_pl, aes(x=year, y=value, fill=status)) +\n  geom_bar(position = position_dodge(width=1), stat='identity') +\n  scale_x_continuous(breaks = c(seq(2010,2023)), labels = c(seq(2010,2023, 1)))+\n  geom_label(aes(label = paste(abs(value), \"k\")),\n             colour = \"white\", fill = \"steelblue4\", fontface=\"bold\", size=3.5) +\n  # facet with ggpol\n  facet_share(~status, dir = \"h\", scales = \"free\", reverse_num = TRUE)+\n  coord_flip() +\n  # title, cap, ..\n  labs(\n    title = p_title,\n    caption = social_caption,\n    y = \"Число браков и разводов в тысячах\",\n    x = NULL\n  ) +\n  # theme, format\n  theme_update()+\n  theme(\n    plot.title = element_markdown(\n      size = 16, color = \"steelblue4\", face = \"bold\", hjust = 0.5),\n    plot.caption = ggtext::element_markdown(size = 14, hjust = 0.5),\n    legend.position = \"none\",\n    axis.title.x = element_text(size = 12),\n    panel.grid.major.x = element_blank(),\n    panel.grid.minor.x = element_blank(),\n    panel.grid.minor.y = element_blank(),\n    panel.background = element_rect(fill = \"ghostwhite\"), \n    plot.background = element_rect(fill = \"azure2\"),\n    strip.background = element_rect(fill = \"linen\", color = \"steelblue\")\n  )\n\n# Show plot\npl\n```\n\n::: {.cell-output-display}\n![](marriage_files/figure-html/unnamed-chunk-7-1.png){width=672}\n:::\n:::\n\n\n## barplot\n\n\n::: {.cell}\n\n```{.r .cell-code}\npl_2 <-\n  ggplot(data = df_pl,\n         aes(x = year, y = value, fill = status)) +\n  geom_bar(stat = \"identity\") + #, position = \"dodge\"\n  scale_y_continuous(\n    breaks = c(seq(-300, 300, by = 50)), \n    #labels = c(seq(300, 0, -50), seq(50, 300, 50)),\n    labels = function(x) paste0(abs(x), \"k\")) +\n  scale_x_continuous(breaks = c(seq(2010,2023)), labels = c(seq(2010,2023, 1)))+\n  coord_flip() +\n  geom_label(aes(label=abs(value)), color = \"white\") +\n  labs(\n    title = p_title,\n    caption = social_caption,\n    y = NULL,\n    x = NULL) +\n  \n  theme_minimal()+\n  theme(\n    plot.title = element_textbox(\n      size = 14, color = \"steelblue4\", face = \"bold\", hjust = 0.5),\n    plot.caption = ggtext::element_markdown(size = 12, hjust = 0.5),\n    legend.position = \"top\",\n    panel.grid.major.x = element_blank(),\n    panel.grid.minor.x = element_blank(),\n    panel.grid.minor.y = element_blank()\n  )\n# show plot\npl_2\n```\n\n::: {.cell-output-display}\n![](marriage_files/figure-html/unnamed-chunk-8-1.png){width=672}\n:::\n:::\n\n\n\n## animated plot for marriage\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# marriage\nplt_anim_mar <-\n  df_pl |> \n  filter(status == \"marriage\") |> \n  mutate(value = abs(value)) |>   # weil df_pl divor values nigativ\n  ggplot(aes(x = as_factor(year), y = value, fill = value))+\n  geom_col()+\n  scale_colour_brewer(type = \"div\", palette = \"BuGn\", direction = 1)+\n  scale_y_continuous(limits = c(0, 300),breaks = seq(0, 300, 50),\n                     labels = function(x) paste0(x, \"k\"))+\n  geom_text(aes(label =  round(value)),\n            vjust = 1.5, nudge_y = 0.5, color = \"white\", size = 4)+\n  labs(\n    title = \"Заключенные браки\", #: {closest_state}\n    #subtitle = \"{closest_state}\",\n    caption = social_caption_anim,\n    y = \"Количество браков (в тысячах, k = 1000)\",\n    x = NULL) +\n  theme_minimal()+\n  theme(\n    plot.title = element_text(size = 16, color = \"steelblue4\", hjust = 0.5),\n    plot.caption = element_textbox(size = 14, hjust = 0.5),\n    axis.title.y = element_text(size = 11, vjust = -0.5),\n    legend.position = \"none\",\n    panel.grid = element_blank(),\n    panel.grid.major.y = element_line(color = \"white\"),\n    panel.ontop = TRUE,\n    ) +\n  \n  #scale_fill_distiller(palette = \"red\", direction = -1) +\n  transition_states(year, wrap = FALSE, transition_length = 14)+\n  #ease_aes(\"cubic-in-out\")+\n  view_follow(fixed_y = TRUE)+\n  shadow_mark()\n\n#plt_anim\nanim1 <-   \n  animate(\n    plt_anim_mar,\n    duration = 15,\n    start_pause = 5,\n    end_pause = 10,\n    renderer = gifski_renderer()\n  )\nanim1\n```\n\n::: {.cell-output-display}\n![](marriage_files/figure-html/unnamed-chunk-9-1.gif)\n:::\n:::\n\n\n\n## animated plot for divorce\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# divorce\nplt_anim_div <-\n  df_pl |> \n  filter(status == \"divorce\") |> \n  mutate(value = abs(value)) |>   # weil df_pl status=divorce values nigativ\n  ggplot(aes(x = as_factor(year), y = value, fill = value))+\n  geom_col()+\n  scale_fill_distiller(palette = \"Reds\", direction = 1)+\n  scale_y_continuous(limits = c(0, 50),breaks = seq(0, 50, 5),\n                     labels = function(x) paste0(x, \"k\"))+\n  geom_text(aes(label =  round(value,1)),\n            vjust = 2, nudge_y = 0.5, color = \"steelblue4\", size = 4)+\n  labs(\n    title = \"Разводы\", #: {closest_state}\n    caption = social_caption_anim,\n    y = \"Количество разводов (в тысячах, k = 1000)\",\n    x = NULL) +\n  theme_minimal()+\n  theme(\n    plot.title = element_text(size = 16, color = \"steelblue4\", hjust = 0.5),\n    plot.caption = element_markdown(size = 14, hjust = 0.5),\n    axis.title.y = element_text(size = 11, vjust = -0.5),\n    legend.position = \"none\",\n    panel.grid = element_blank(),\n    panel.grid.major.y = element_line(color = \"white\"),\n    panel.ontop = TRUE) +\n  \n  #scale_fill_distiller(palette = \"red\", direction = -1) +\n  transition_states(year, wrap = FALSE)+\n  #ease_aes(\"cubic-in-out\")+\n  view_follow(fixed_y = TRUE)+\n  shadow_mark()\n\n#plt_anim\nanim2 <-   \n  animate(\n    plt_anim_div,\n    duration = 15,\n    start_pause = 5,\n    end_pause = 10,\n    renderer = gifski_renderer()\n  )\nanim2\n```\n\n::: {.cell-output-display}\n![](marriage_files/figure-html/unnamed-chunk-10-1.gif)\n:::\n:::\n",
    "supporting": [
      "marriage_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<link href=\"../site_libs/pagedtable-1.1/css/pagedtable.css\" rel=\"stylesheet\" />\r\n<script src=\"../site_libs/pagedtable-1.1/js/pagedtable.js\"></script>\r\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}